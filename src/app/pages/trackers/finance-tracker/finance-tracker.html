<div class="page">
  <header class="page-header">
    <h1 class="page-title">Finance Tracker</h1>
    <p class="page-subtitle">
      Na početku mjeseca unesi prihode i fiksne troškove, a kroz mjesec dodaj troškove po kategorijama.
    </p>
  </header>

  <!-- Odabir mjeseca -->
  <section class="card finance-card">
    <div class="month-switcher">
      <button type="button" class="btn-secondary" (click)="changeMonth(-1)">
        &laquo;
      </button>
      <span class="month-label">{{ getMonthLabel() }}</span>
      <button type="button" class="btn-secondary" (click)="changeMonth(1)">
        &raquo;
      </button>
    </div>

    <!-- Prihodi i fiksni troškovi -->
    <div class="top-fields">
      <label class="field">
        <span class="field-label">Prihod (mjesečno)</span>
        <input
          class="field-input"
          type="number"
          [(ngModel)]="model.income"
          name="income"
          min="0"
          (change)="onIncomeChange()" />
      </label>

      <label class="field">
        <span class="field-label">Fiksni troškovi</span>
        <input
          class="field-input"
          type="number"
          [(ngModel)]="model.fixedExpenses"
          name="fixed"
          min="0"
          (change)="onFixedChange()" />
      </label>
    </div>
  </section>

  <!-- Dodavanje troška + lista troškova -->
  <section class="finance-layout">
    <div class="card finance-card">
      <h3 class="section-title">Dodaj trošak</h3>
      <form (ngSubmit)="addTransaction()" #txForm="ngForm" class="tx-form">
        <label class="field">
          <span class="field-label">Datum</span>
          <input
            class="field-input"
            type="date"
            [(ngModel)]="txDate"
            name="txDate"
            required />
        </label>

        <label class="field">
          <span class="field-label">Iznos</span>
          <input
            class="field-input"
            type="number"
            [(ngModel)]="txAmount"
            name="txAmount"
            min="0.01"
            step="0.01"
            required />
        </label>

        <label class="field">
          <span class="field-label">Kategorija</span>
          <select
            class="field-input"
            [(ngModel)]="txCategory"
            name="txCategory">
            <option *ngFor="let c of categories" [ngValue]="c.value">
              {{ c.label }}
            </option>
          </select>
        </label>

        <label class="field">
          <span class="field-label">Opis</span>
          <input
            class="field-input"
            type="text"
            [(ngModel)]="txDescription"
            name="txDescription"
            placeholder="Npr. kafa s prijateljima" />
        </label>

        <button type="submit" class="btn-primary">
          Dodaj trošak
        </button>
      </form>
    </div>

    <div class="card finance-card">
      <h3 class="section-title">Troškovi u mjesecu</h3>

      <table class="tx-table" *ngIf="model.transactions.length; else noTx">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Iznos</th>
            <th>Kategorija</th>
            <th>Opis</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let t of model.transactions">
            <td>{{ t.date }}</td>
            <td>{{ t.amount | number: '1.2-2' }}</td>
            <td>{{ categoryLabel(t.category) }}</td>
            <td>{{ t.description }}</td>
            <td>
              <button
                type="button"
                class="icon-btn"
                (click)="deleteTransaction(t.id)">
                ✕
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <ng-template #noTx>
        <p>Još nema varijabilnih troškova za ovaj mjesec.</p>
      </ng-template>
    </div>
  </section>

  <!-- Analitika -->
  <section class="card finance-card">
    <h3 class="section-title">Analitika troškova</h3>

    <div class="summary-boxes">
      <div class="summary-item">
        <strong>Prihod:</strong>
        <span>{{ model.income | number: '1.2-2' }}</span>
      </div>
      <div class="summary-item">
        <strong>Fiksni troškovi:</strong>
        <span>{{ model.fixedExpenses | number: '1.2-2' }}</span>
      </div>
      <div class="summary-item">
        <strong>Varijabilni troškovi:</strong>
        <span>{{ totalVariable | number: '1.2-2' }}</span>
      </div>
      <div
        class="summary-item"
        [class.positive]="leftover >= 0"
        [class.negative]="leftover < 0">
        <strong>Ostaje:</strong>
        <span>{{ leftover | number: '1.2-2' }}</span>
      </div>
    </div>

    <h4>Potrošnja po kategorijama</h4>
    <table class="category-table">
      <thead>
        <tr>
          <th>Kategorija</th>
          <th>Iznos</th>
          <th>Udio u var. troškovima</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of categories">
          <td>{{ c.label }}</td>
          <td>{{ sumByCategory[c.value] | number: '1.2-2' }}</td>
          <td>
            {{ percentByCategory[c.value] }} %
            <div class="percent-bar">
              <div
                class="percent-fill"
                [style.width.%]="percentByCategory[c.value]">
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </section>
</div>
